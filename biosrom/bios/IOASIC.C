//
// Copyright (c) 1997 by Midway Video Inc.
//
// $Revision: 8 $
//
// $Author: Mlynch $
//
#include	<system.h>
#include	<io.h>
#include	<ioctl.h>

#if (!(PHOENIX_SYS & VEGAS))
#define	LONG	long
#define	INT	int
#else
#define	LONG	short
#define	INT	short
#endif

/*
 * This array contains addresses of where to write the various portions of
 * stuff to the I/O ASIC in order to accomplish the UnLock proccess.
 * NOTE: VERRRY DEPENDENT ON misc.h
 */
#if (PHOENIX_SYS & SA1)
#define	OFFSET_SHIFT	3
#elif (PHOENIX_SYS & SEATTLE)
#define	OFFSET_SHIFT	2
#elif (PHOENIX_SYS & FLAGSTAFF)
#error ioasic.c - FLAGSTAFF not supported yet
#elif (PHOENIX_SYS & VEGAS)
#define	OFFSET_SHIFT	1
#else
#error PHOENIX_SYS is not set
#endif

unsigned LONG *PICAddr[] = {
(unsigned LONG *)(IO_ASIC_BASE + (3 << OFFSET_SHIFT)),
(unsigned LONG *)(IO_ASIC_BASE + (2 << OFFSET_SHIFT)),	
(unsigned LONG *)(IO_ASIC_BASE + (0 << OFFSET_SHIFT))
};


/*
 * These two arrays simply contain values and addresses to write the
 * values to in order to unlock the I/O ASIC.
 */

static unsigned LONG PIC1[] = {
0x002b, 0x0093, 0x00a7, 0x004e, 0x0000, 0x000e, -1
};

#if defined(B99)
static int	ioasic_unlock_data[] = {
0x38A29C49, 0xDE72902F, 0x6327184F, 0x7399D020, 
0xF3DDD141, 0xDE42EE53, 0x7A465449, 0x22F8AD43, 
0x3CF32C20, 0xFD91D755, 0x9F79C46E, 0x6E04D26C, 
0xB5C1B66F, 0x4076DA63, 0xD242F86B, 0x8115E920, 
0x82211A44, 0xBA919D61, 0x9BF25174, 0x5E073961, 
0x2D7F5320, 0xE88ED966, 0x1353746F, 0x59EDB472, 
0xD25B4920, 0xC0B21D42, 0x377D806C, 0x3A82FC69, 
0x69DBB474, 0xCDAD997A, 0x7BD1F720, 0xA27E5027, 
0xAC202939, 0xDEF91039, 0x16182120, 0x9FFDFB50, 
0xBD3BFE49, 0x905E7543, 0xC2F6A820, 0xFA2F2A4D, 
0x8DF04C69, 0x62706C63, 0x6833FC72, 0x43B2026F, 
0xA2E74663, 0x3A76F46F, 0xC4C7EC6E, 0x25086174, 
0xF5089172, 0x60BA3D6F, 0x830F9A6C, 0x2287E46C, 
0x49491665, 0x96630F72, 0x7C75980D, 0x1BA45F0A, 
0x57152C43, 0xB3F3196F, 0x56275C70, 0xC0F0E079, 
0x81A0B272, 0xD1F95369, 0x636F3167, 0x2DC0DC68, 
0xB0F26374, 0x79875220, 0xCDBED728, 0x6E2E6163, 
0x09E5C729, 0x90B57F20, 0x685D8C31, 0x97D61439, 
0xF325EC39, 0xD0918838, 0xDB881620, 0x960D3262, 
0x0B087D79, 0xA0500220, 0xBB15934D, 0x00110E69, 
0x010A3F64, 0x3E252E77, 0x2298F361, 0x4A535679, 
0xD4883D20, 0x9F0E8B56, 0x65F7B569, 0x2B9D6964, 
0x5301A465, 0xBC1F116F, 0xEC8E4A20, 0xD4A25749, 
0x8E18656E, 0x4FFD7B63, 0x0263332E, 0x3F0AC80D, 
0xC984CD0A, 0xD0220A0D, 0xAD392A0A, 0xD36A9441, 
0x60D7896C, 0x1596B66C, 0x6B40A820, 0x53FD7552, 
0xE6283E69, 0x46C8BF67, 0xEA0AA868, 0xF130BB74, 
0xE718C173, 0xA5203B20, 0xF141CA52, 0xE8230165, 
0xE3456973, 0x13DABD65, 0x32765772, 0xB7CDA676, 
0xB2E94865, 0x986E0C64, 0xE36B100D, 0x05EAED0A, 
0x548D1E0D, 0xCFF95A0A, 0xDA8D4455, 0xE2A58373, 
0x1FF6D565, 0xDCF0772C, 0x21B04B20, 0xE97BA264, 
0xAD128175, 0xCEE97570, 0xBCE6366C, 0x0DEA0A69, 
0xE4802B63, 0x2826DF61, 0x61E78074, 0xCAA86A69, 
0x6EEF9E6F, 0x4BF2286E, 0xBBD9252C, 0x56085F20, 
0xF112636F, 0xAD1AEF72, 0x3E2B6020, 0xD457CD64, 
0xC0F5AC69, 0x70A1B773, 0x8C257363, 0x73DEF56C, 
0x090FC46F, 0x6F908373, 0x79C9E275, 0x5D9CE272, 
0x3F89DD65, 0x54572620, 0x40426569, 0x5F80B273, 
0x31479D20, 0x61F2B073, 0x48FC5474, 0xDE5A1E72, 
0x30DC2669, 0x05E28B63, 0xEC44286B, 0x155C516C, 
0x2E096A79, 0x4E2BA820, 0xE004BB70, 0x9CF90872, 
0x9A1DD06F, 0x9BDDE168, 0xF3016769, 0x8B303462, 
0x48F8D069, 0x312CC874, 0x5F880165, 0x09EE7D64, 
0xA1CE7F20, 0xEBAD7475, 0x7DCD726E, 0xAADE436C, 
0x5B3DF865, 0xF7975473, 0x087B2573, 0x9AC7D520, 
0x4BEE7A61, 0x48BD8A70, 0xFA488870, 0x7D361772, 
0xAAB03B6F, 0x4344DC76, 0x5B903565, 0xDB8C6164, 
0x4927670D, 0x47D45D0A, 0xF0E8B269, 0x7730D16E, 
0x96000620, 0xD0ED6E77, 0x1429D972, 0x301DD669, 
0x6CCB4F74, 0x072B4169, 0xBB4E0A6E, 0xB5C41F67, 
0x38580920, 0x1AD60B62, 0xBFB29C79, 0xDA268820, 
0x0683804D, 0x3D800E69, 0x8504CC64, 0x61C17877, 
0x35176261, 0x8D7FF179, 0xFC894D20, 0x8105DC56, 
0xD63D7C69, 0xF6D1D564, 0xFE3BF365, 0x80EDB76F, 
0x3A16B220, 0x59CC2849, 0x5C7A186E, 0x833E1963, 
0xA1A0862E, 0x4D62CA0D, 0xFA6EEB0A, 0x37A08C0D, 
0x1E50380A, 0x0E98C456, 0x67BE6269, 0x8B1B876F, 
0x15C4056C, 0x230C6D61, 0x40DFA774, 0x4E1C0E6F, 
0x3DE27872, 0x00924373, 0x28429720, 0x4465F877, 
0x3E125269, 0xAD47636C, 0xA627706C, 0x7329B420, 
0x3AC75462, 0xA2B0BE65, 0xF42F9120, 0x1104D073, 
0x99829368, 0xF26B846F, 0x91F28774, 0xD3994521, 
0x4C37AD21, 0xEE6C9F21, 0x56D75F0D, 0xEDD8330A, 
0x3BCF6A0D, 0x51464A0A, 0x2578BF53, 0x5A1FA274, 
0x5FDF0E65, 0x8D372176, 0xE53B2A65, 0x75A31420, 
0xB0438E43, 0x261AD16F, 0xC3BF2272, 0xEE260772, 
0x26AD1465, 0xEC01B96C, 0x328BFF6C, 0x64BF6620, 
0x99491C69, 0xD8B37073, 0xD7E91B20, 0xD4107154, 
0x7B642E48, 0xCC18AC45, 0xE5154120, 0x14E6C162, 
0xBE843065, 0x7707C973, 0xE8800774, 0x0ABBDD20, 
0x65746868, 0x3F576661, 0xF8941072, 0xA143D264, 
0x909DB077, 0x1E0CCF61, 0xFB637572, 0xF07CBE65, 
0xAB43F120, 0xE09E9F65, 0x661FD26E, 0x5B877F67, 
0x06B97069, 0x29DEF56E, 0x49AD8665, 0x2D668465, 
0x15E0AE72, 0x7C398620, 0x9225EB74, 0xAF29CB68, 
0x54ECF665, 0x6A0F0672, 0x833A3C65, 0xD0512420, 
0x3627B269, 0x684F7D73, 0xE537E521, 0xF4ABE20D, 
0xDF57460A, 0xCDB7EC0D, 0xFF67C00A, 0x44CBAF4D, 
0x0D0F5269, 0xF7FBD06B, 0xE60F8165, 0x9DAD0220, 
0x1608A04C, 0xE172F679, 0x8E29C16E, 0xC14C9163, 
0xC2119568, 0xF4499320, 0x1CD41069, 0xC8CB0573, 
0x1E288820, 0x66819754, 0xF6318A48, 0x34093745, 
0xE2BB1D20, 0x88577562, 0xE3330265, 0x37A81373, 
0xF2667B74, 0x666D3E20, 0x07F93773, 0x288E2D6F, 
0xCEBCBB66, 0xED311C74, 0x1D3A0F77, 0xAE140261, 
0xBAE90972, 0x1CA1CF65, 0xF2DFB120, 0xC7F85B65, 
0x149DA06E, 0xD8EF3267, 0x65A55E69, 0x2AA6406E, 
0xBA622965, 0xF3CF1F65, 0xEBF2D172, 0x7C73BE20, 
0xE818B274, 0x08C6E168, 0x453EC465, 0x06413B72, 
0x6F487865, 0x3B704E20, 0x3A4A7269, 0x52039573, 
0xC3C7C321, 0x1D7D740D, 0x89ABA80A, 0x0,
};
#elif defined(NBA)
//irsult: 0x00649FA6
static int	ioasic_unlock_data[] = {
0xF5D5A649, 0x53816B2F, 0xDDBD654F, 0x3D3A8520, 
0x54052641, 0x6A588A53, 0xCCD1E749, 0x3A7F0A43, 
0x2B462920, 0xE0DCE955, 0xCCCA4E6E, 0x684A6F6C, 
0x9BFFFE6F, 0x3CED0B63, 0xFFF3926B, 0x9359B220, 
0xFC8BAC44, 0x510E3061, 0x941B1374, 0x7EB86D61, 
0x17867A20, 0x6ACBD566, 0x9123196F, 0x0A609C72, 
0x42380A20, 0xDD9BDF4E, 0x2246D642, 0xE8A11341, 
0x29574F20, 0x05257C6F, 0x35E0C76E, 0x1F2CF520, 
0x58A6E74E, 0x139E2C42, 0x5C677A43, 0xACAC0E20, 
0x7DF6B650, 0x29396249, 0xE72B1843, 0xA93CDF20, 
0x0A164B4D, 0xB3F56769, 0x11874F63, 0xA6164A72, 
0xF0E2726F, 0x117AE163, 0x396FFC6F, 0xED6E1E6E, 
0x62891274, 0xCD8B1072, 0x6C268B6F, 0x7A0F8C6C, 
0x3856E56C, 0xFD49A465, 0x84702872, 0x7A8EEF0D, 
0xDAE5840A, 0xA6B6FE43, 0x6330026F, 0x043CD370, 
0xABDC7B79, 0x9910C972, 0x2369C869, 0x04836267, 
0xACAEF568, 0x7FD14274, 0xB12F7020, 0x2AA5AC28, 
0xA90AA463, 0x985A8929, 0xD3E28B20, 0xB320F031, 
0x4C4FF039, 0xE569DA39, 0x59373A38, 0x3D326220, 
0xF6E4BC62, 0x92A73679, 0x2AA08020, 0x596DCE4D, 
0x60324669, 0x96C70B64, 0xD37D5A77, 0x98892C61, 
0x9410AF79, 0x57ED8320, 0x13181B56, 0x6EF63369, 
0xFEA48164, 0x76481E65, 0x7333066F, 0xAA80FC20, 
0x0F58E749, 0x969CCE6E, 0xAF045F63, 0xBC07DD2E, 
0x166E110D, 0x6033CF0A, 0xE6AD890D, 0xBF78B50A, 
0xF88E5841, 0xBA90146C, 0x7299A56C, 0x44DE4820, 
0x9FF9EF52, 0xCBD0DF69, 0x8210AA67, 0x96DEAB68, 
0x5E781674, 0xACB12A73, 0xF04C7920, 0xBEAA5C52, 
0x43783565, 0xC3C9D373, 0x57338865, 0xD788E572, 
0x1BB75676, 0x6A4BA465, 0x467F1864, 0x1A5BD80D, 
0xE093C20A, 0xB9B21F0D, 0xC4DCD40A, 0xEFECA955, 
0x504EED73, 0x73E13365, 0xABF4862C, 0x66BCFE20, 
0xD4150364, 0x92A20F75, 0x2635B470, 0xCCA35B6C, 
0x4D322469, 0x98CF5963, 0x1181A461, 0xED2C1374, 
0x64A03969, 0x93924E6F, 0x840ABE6E, 0xC3184F2C, 
0x40437920, 0x7457376F, 0x81C2AB72, 0x83BBAE20, 
0x38210A64, 0xD8F63469, 0x5B449373, 0x53D86163, 
0x4341D86C, 0xA1C3AC6F, 0x6E343973, 0x23D59A75, 
0x5B75CB72, 0x33110D65, 0x13C24320, 0xABC4B869, 
0xA6F24173, 0xBFB6CA20, 0x1281B773, 0x7B074474, 
0x5258D972, 0x38B76B69, 0x47AA9F63, 0x9F8AFD6B, 
0xD186C46C, 0x592C4379, 0x8CB71020, 0x3626FD70, 
0xECBE9272, 0x10C1CE6F, 0xF93F4C68, 0x2D020B69, 
0x85190562, 0x7B01F869, 0xB0BDB974, 0xBD3A1065, 
0x53F82C64, 0x0C024D20, 0x11127175, 0x973A046E, 
0xADC5F96C, 0x7F46AA65, 0xBB0F9E73, 0x093BC473, 
0xB257B720, 0xCED1E161, 0xB5007C70, 0x5949F870, 
0x8E88AB72, 0xC782336F, 0xD4513C76, 0xE0E18565, 
0x00399E64, 0x1BFBDC0D, 0x806C820A, 0xD1C06369, 
0x75281F6E, 0x0D239320, 0x07E76077, 0x61E6B172, 
0x1DE56169, 0x0126AD74, 0x8EE8BC69, 0xA2FE676E, 
0x7C28A567, 0x3FA67620, 0x60387762, 0xD020D179, 
0x4BA8C320, 0x714AE84D, 0x675AD569, 0xF96EBC64, 
0xF0919277, 0x226A7361, 0x02AA8079, 0xA2E94920, 
0xF13C5456, 0xB7AAFC69, 0xFC334264, 0x7FC50065, 
0x7F2D306F, 0xD0847E20, 0x60A68549, 0x7F66CE6E, 
0xEC805A63, 0xE113072E, 0x5127310D, 0x61A87A0A, 
0xEE369A0D, 0x590E920A, 0xC38F2B56, 0x0C1BFC69, 
0x5A353F6F, 0x5277E86C, 0xAF1A6361, 0xD65DE474, 
0x921E5E6F, 0x0F52DA72, 0xA67EB573, 0xDDC72120, 
0x809DC277, 0x0DD98A69, 0xD735DD6C, 0x712F546C, 
0x3043FD20, 0xD9E05D62, 0x14189D65, 0x21805120, 
0x918B5973, 0x104BDF68, 0xA145516F, 0x10B88974, 
0xE0D05E21, 0x01EBD621, 0x901F5821, 0xCD50B80D, 
0xE2FEDE0A, 0x0,
};
#else
static unsigned LONG PIC2[] = {
0x6f43, 0x7970, 0x6972, 0x6867, 0x2074, 0x4328, 0x2029, 0x3931,
0x3539, 0x4d20, 0x6469, 0x6177, 0x2079, 0x614d, 0x756e, 0x6166,
0x7463, 0x7275, 0x6e69, 0x2067, 0x6f43, 0x706d, 0x6e61, 0x2079,
0x2d2d, 0x5020, 0x6f72, 0x7270, 0x6569, 0x6174, 0x7972, 0x2d20,
0x202d, 0x7375, 0x2065, 0x7570, 0x7372, 0x6175, 0x746e, 0x7420,
0x206f, 0x694d, 0x7764, 0x7961, 0x4d20, 0x6e61, 0x6675, 0x6361,
0x7574, 0x6972, 0x676e, 0x4320, 0x6d6f, 0x6170, 0x796e, 0x6920,
0x736e, 0x7274, 0x6375, 0x6974, 0x6e6f, 0x2073, 0x2d2d, 0x6620,
0x726f, 0x6920, 0x746e, 0x7265, 0x616e, 0x206c, 0x7375, 0x2e65,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0
};

static unsigned LONG PIC3[] = {
0x4343, 0x6f6f, 0x7070, 0x7979, 0x7272, 0x6969, 0x6767, 0x6868,
0x7474, 0x2020, 0x2828, 0x4343, 0x2929, 0x2020, 0x3131, 0x3939,
0x3939, 0x3535, 0x2020, 0x4d4d, 0x6969, 0x6464, 0x7777, 0x6161,
0x7979, 0x2020, 0x4d4d, 0x6161, 0x6e6e, 0x7575, 0x6666, 0x6161,
0x6363, 0x7474, 0x7575, 0x7272, 0x6969, 0x6e6e, 0x6767, 0x2020,
0x4343, 0x6f6f, 0x6d6d, 0x7070, 0x6161, 0x6e6e, 0x7979, 0x2020,
0x2d2d, 0x2d2d, 0x2020, 0x5050, 0x7272, 0x6f6f, 0x7070, 0x7272,
0x6969, 0x6565, 0x7474, 0x6161, 0x7272, 0x7979, 0x2020, 0x2d2d,
0x2d2d, 0x2020, 0x7575, 0x7373, 0x6565, 0x2020, 0x7070, 0x7575,
0x7272, 0x7373, 0x7575, 0x6161, 0x6e6e, 0x7474, 0x2020, 0x7474,
0x6f6f, 0x2020, 0x4d4d, 0x6969, 0x6464, 0x7777, 0x6161, 0x7979,
0x2020, 0x4d4d, 0x6161, 0x6e6e, 0x7575, 0x6666, 0x6161, 0x6363,
0x7474, 0x7575, 0x7272, 0x6969, 0x6e6e, 0x6767, 0x2020, 0x4343,
0x6f6f, 0x6d6d, 0x7070, 0x6161, 0x6e6e, 0x7979, 0x2020, 0x6969,
0x6e6e, 0x7373, 0x7474, 0x7272, 0x7575, 0x6363, 0x7474, 0x6969,
0x6f6f, 0x6e6e, 0x7373, 0x2020, 0x2d2d, 0x2d2d, 0x2020, 0x6666,
0x6f6f, 0x7272, 0x2020, 0x6969, 0x6e6e, 0x7474, 0x6565, 0x7272,
0x6e6e, 0x6161, 0x6c6c, 0x2020, 0x7575, 0x7373, 0x6565, 0x2e2e,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0
};
#endif

static unsigned LONG PIC4[] = {
0x0054, 0x0029, 0x00e2, -1
};


/*
 * The number of times PICWrite attempts to write before giving up and
 * shitcanning the operation.
 */

#define PIC_MAX_WRITES 100

/*
 * Function prototypes for functions living in this file.
 */

static LONG PICWrite(unsigned LONG, unsigned LONG *);
static LONG PICReady(void);

static LONG PICWrite(unsigned LONG Data, unsigned LONG *Address)
{

	long i;
	unsigned short *wAddr, wData;

	wAddr = ASIC_WORD;
	for(i = 0; i < PIC_MAX_WRITES; i++)
	{
		wData = *wAddr;
		if((wData & 0xe000) != 0x2000)
		{
			continue;
		}
		*Address = Data;
		wData = *wAddr;		/* read added here for debug */
		return (TRUE);
	}
	return (FALSE);
}

static LONG PICReady(void)
{
	unsigned short wValue, *wAddr;

	wAddr = ASIC_WORD;
	wValue = *wAddr;
	return (wValue & PIC_READY);
}

int unlock_ioasic(void)
{
	long i;

	unsigned LONG iValue, *iAddr, *iData;
	unsigned short wValue;

#if (PHOENIX_SYS & SA1)
	// Set the reset bit
	*((volatile int *)IOASIC_RESET_ADDR) = 0x00000000;

	// Wait a little bit
	for(i = 0; i < 400000; i++)
	{
		;		/* reset delay loop */
	}

	// Reset the reset bit
	*((volatile int *)IOASIC_RESET_ADDR) = 0x00000001;
#elif (PHOENIX_SYS & SEATTLE)
	// Set the reset bit
	*((volatile int *)IOASIC_RESET_ADDR) &= ~RST_IOASIC;

	// Wait a little bit
	for(i = 0; i < 400000; i++)
	{
		;		/* reset delay loop */
	}

	// Reset the reset bit
	*((volatile int *)IOASIC_RESET_ADDR) |= RST_IOASIC;
#elif (PHOENIX_SYS & FLAGSTAFF)
#error ioasic.c - FLAGSTAFF not supported yet
#elif (PHOENIX_SYS & VEGAS)
	// Set the reset bit
	*((volatile char *)IOASIC_RESET_ADDR) &= (char)~RST_IOASIC;

	// Wait a little bit
//	for(i = 0; i < 400000; i++)
	for(i = 0; i < 8000000; i++)
	{
		;		/* reset delay loop */
	}

	// Reset the reset bit
	*((volatile char *)IOASIC_RESET_ADDR) |= RST_IOASIC;
#else
#error ioasic.c - PHOENIX_SYS not set
#endif

	// Wait for the PIC to say it is ready
	for(i = 0; i < 100000000; i++)
	{
		if(PICReady())
		{
			break;
		}
	}

	// Did we timeout ?
	if(!PICReady())
	{
		// YES - error
		return(-1);
	}

	iAddr = PICAddr[0];
	for(i = 0;;)
	{
		if((iValue = PIC1[i++]) == (unsigned LONG)-1)
		{
			break;
		}
		if(PICWrite(iValue, iAddr))
		{
			continue;
		}
		return(-1);
	}
	iAddr = PICAddr[1];
#if defined(B99)
	iData = (unsigned LONG *)ioasic_unlock_data;
	for(i = 0; i < 16384; i++)
	{
		if(!*iData)
		{
			iData = (unsigned LONG *)ioasic_unlock_data;
		}
		if(PICWrite(*iData, iAddr))
		{
			iData++;
			continue;
		}
		return(-2);
	}
#elif defined(NBA)
	iData = (unsigned LONG *)ioasic_unlock_data;
	for(i = 0; i < 16384; i++)
	{
		if(!*iData)
		{
			iData = (unsigned LONG *)ioasic_unlock_data;
		}
		if(PICWrite(*iData, iAddr))
		{
			iData++;
			continue;
		}
		return(-2);
	}
#else
	iData = PIC2;
	for(i = 0; i < 16384; i++)
	{
		if(!(iValue = *iData++))
		{
			iData = PIC3;
			iValue = *iData++;
		}
		if(PICWrite(iValue, iAddr))
		{
			continue;
		}
		return(-2);
	}			
#endif
	iAddr = PICAddr[2];
	for(i = 0;;)
	{
		if((iValue = PIC4[i++]) == (unsigned LONG)-1)
		{
			break;
		}
		if(PICWrite(iValue, iAddr))
		{
			continue;
		}
		return(-3);
	}
//	for(i = 0; i < 400000; i++)
#if (PHOENIX_SYS & SA1)
	*((volatile INT *)LED_ADDR) = 0xff;
#elif (PHOENIX_SYS & SEATTLE)
	*((volatile INT *)LED_ADDR) = 0;
#endif
	
	while(1)
	{
		wValue = *MAIN_CONTROL;
		if(wValue == 0)
		{
			break;
		}
	}
	if(wValue)
	{
#if (PHOENIX_SYS & (SEATTLE|VEGAS))
		*MAIN_CONTROL ^= (1<<14);
#endif
		return(1);
	}

#if (PHOENIX_SYS & SA1)
	*((volatile INT *)LED_ADDR) = 0;
#elif (PHOENIX_SYS & SEATTLE)
	*((volatile INT *)LED_ADDR) = 0x7;
#endif

	*MAIN_CONTROL = 0;
#if (PHOENIX_SYS & (SEATTLE|VEGAS))
	*MAIN_CONTROL ^= (1<<14);
#endif
	return(0);
}

int ioasicioctl(register struct iocntb *io, int cmd, int arg)
{
	switch(cmd)
	{
		case FIOCGETDIPSWITCHES:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_DIP_SWITCHES) & 0xffff;
			break;
		}
		case FIOCGETCOININPUTS:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_COIN_INPUT) & 0xffff;
			break;
		}
		case FIOCGETPLAYER12:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_PLAYER_12) & 0xffff;
			break;
		}
		case FIOCGETPLAYER34:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_PLAYER_34) & 0xffff;
			break;
		}
		case FIOCGETCOINMETERS:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_COIN_METERS) & 0xffff;
			break;
		}
		case FIOCSETCOINMETERS:
		{
			*((volatile INT *)IOASIC_COIN_METERS) = (arg & 0xffff);
			break;
		}
		case FIOCSETSOUNDCONTROL:
		{
			*((volatile INT *)IOASIC_SOUND_CONTROL) = (arg & 0xffff);
			break;
		}
		case FIOCGETSOUNDCONTROL:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_SOUND_CONTROL) & 0xffff;
			break;
		}
		case FIOCSETSOUNDDATA:
		{
			*((volatile INT *)IOASIC_SOUND_DATA_OUT) = (arg & 0xffff);
			break;
		}
		case FIOCGETSOUNDSTATUS:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_SOUND_STATUS) & 0xffff;
			break;
		}
		case FIOCGETSOUNDDATA:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_SOUND_DATA_IN) & 0xffff;
			break;
		}
		case FIOCSETPICCOMMAND:
		{
			*((volatile INT *)IOASIC_PIC_COMMAND) = (arg & 0xffff);
			break;
		}
		case FIOCGETPICCOMMAND:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_PIC_COMMAND) & 0xffff;
			break;
		}
		case FIOCGETPICDATA:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_PIC_DATA_IN) & 0xffff;
			break;
		}
		case FIOCGETSTATUS:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_STATUS) & 0xffff;
			break;
		}
		case FIOCSETCONTROL:
		{
			*((volatile INT *)IOASIC_CONTROL) = (arg & 0xffff);
			break;
		}
		case FIOCGETCONTROL:
		{
			*((int *)arg) = *((volatile INT *)IOASIC_CONTROL) & 0xffff;
			break;
		}
		case FIOCSETSTHDATA:
		{
			*((volatile INT *)IOASIC_SOUND_DATA_IN) = (arg & 0xffff);
			break;
		}
		case FIOCSETAUXPORT:
		{
			*((volatile INT *)IOASIC_PIC_DATA_IN) = (arg & 0xffff);
			break;
		}
		default:
		{
			return(-1);
		}
	}
	return(0);
}
