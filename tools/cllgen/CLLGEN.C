#include	<stdio.h>
#include	<stdlib.h>
#include	<sys/time.h>

static unsigned int	ihdat_table[] = {
0xaaa,
0x555,
0x636,
0x59c
};

static unsigned int	xreg_table[] = {
0x28,
0x53,
0x91,
0xa2
};

static unsigned int	cnt_table[] = {
0x000001,
0x000002,
0x000004,
0x000008,
0x000010,
0x000020,
0x000040,
0x000080,
0x000100,
0x000200,
0x000400,
0x000800,
0x001000,
0x002000,
0x004000,
0x008000,
0x010000,
0x020000,
0x040000,
0x080000,
0x100000,
0x200000,
0x400000,
0x800000,
0x000001,
0x000010,
0x000100,
0x001000,
0x010000,
0x100000,
0x020000,
0x002000
};

static unsigned int PIC2[] = {
0x6f43, 0x7970, 0x6972, 0x6867, 0x2074, 0x4328, 0x2029, 0x3931,
0x3539, 0x4d20, 0x6469, 0x6177, 0x2079, 0x614d, 0x756e, 0x6166,
0x7463, 0x7275, 0x6e69, 0x2067, 0x6f43, 0x706d, 0x6e61, 0x2079,
0x2d2d, 0x5020, 0x6f72, 0x7270, 0x6569, 0x6174, 0x7972, 0x2d20,
0x202d, 0x7375, 0x2065, 0x7570, 0x7372, 0x6175, 0x746e, 0x7420,
0x206f, 0x694d, 0x7764, 0x7961, 0x4d20, 0x6e61, 0x6675, 0x6361,
0x7574, 0x6972, 0x676e, 0x4320, 0x6d6f, 0x6170, 0x796e, 0x6920,
0x736e, 0x7274, 0x6375, 0x6974, 0x6e6f, 0x2073, 0x2d2d, 0x6620,
0x726f, 0x6920, 0x746e, 0x7265, 0x616e, 0x206c, 0x7375, 0x2e65,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0
};

static unsigned int PIC3[] = {
0x4343, 0x6f6f, 0x7070, 0x7979, 0x7272, 0x6969, 0x6767, 0x6868,
0x7474, 0x2020, 0x2828, 0x4343, 0x2929, 0x2020, 0x3131, 0x3939,
0x3939, 0x3535, 0x2020, 0x4d4d, 0x6969, 0x6464, 0x7777, 0x6161,
0x7979, 0x2020, 0x4d4d, 0x6161, 0x6e6e, 0x7575, 0x6666, 0x6161,
0x6363, 0x7474, 0x7575, 0x7272, 0x6969, 0x6e6e, 0x6767, 0x2020,
0x4343, 0x6f6f, 0x6d6d, 0x7070, 0x6161, 0x6e6e, 0x7979, 0x2020,
0x2d2d, 0x2d2d, 0x2020, 0x5050, 0x7272, 0x6f6f, 0x7070, 0x7272,
0x6969, 0x6565, 0x7474, 0x6161, 0x7272, 0x7979, 0x2020, 0x2d2d,
0x2d2d, 0x2020, 0x7575, 0x7373, 0x6565, 0x2020, 0x7070, 0x7575,
0x7272, 0x7373, 0x7575, 0x6161, 0x6e6e, 0x7474, 0x2020, 0x7474,
0x6f6f, 0x2020, 0x4d4d, 0x6969, 0x6464, 0x7777, 0x6161, 0x7979,
0x2020, 0x4d4d, 0x6161, 0x6e6e, 0x7575, 0x6666, 0x6161, 0x6363,
0x7474, 0x7575, 0x7272, 0x6969, 0x6e6e, 0x6767, 0x2020, 0x4343,
0x6f6f, 0x6d6d, 0x7070, 0x6161, 0x6e6e, 0x7979, 0x2020, 0x6969,
0x6e6e, 0x7373, 0x7474, 0x7272, 0x7575, 0x6363, 0x7474, 0x6969,
0x6f6f, 0x6e6e, 0x7373, 0x2020, 0x2d2d, 0x2d2d, 0x2020, 0x6666,
0x6f6f, 0x7272, 0x2020, 0x6969, 0x6e6e, 0x7474, 0x6565, 0x7272,
0x6e6e, 0x6161, 0x6c6c, 0x2020, 0x7575, 0x7373, 0x6565, 0x2e2e,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020, 0x2020,
0
};

static char	ioasic_unlock_data[] = {
0x49, 0x2F, 0x4F, 0x20, 0x41, 0x53, 0x49, 0x43, 
0x20, 0x55, 0x6E, 0x6C, 0x6F, 0x63, 0x6B, 0x20, 
0x44, 0x61, 0x74, 0x61, 0x20, 0x66, 0x6F, 0x72, 
0x20, 0x42, 0x6C, 0x69, 0x74, 0x7A, 0x20, 0x27, 
0x39, 0x39, 0x20, 0x50, 0x49, 0x43, 0x20, 0x4D, 
0x69, 0x63, 0x72, 0x6F, 0x63, 0x6F, 0x6E, 0x74, 
0x72, 0x6F, 0x6C, 0x6C, 0x65, 0x72, 0x0D, 0x0A, 
0x43, 0x6F, 0x70, 0x79, 0x72, 0x69, 0x67, 0x68, 
0x74, 0x20, 0x28, 0x63, 0x29, 0x20, 0x31, 0x39, 
0x39, 0x38, 0x20, 0x62, 0x79, 0x20, 0x4D, 0x69, 
0x64, 0x77, 0x61, 0x79, 0x20, 0x56, 0x69, 0x64, 
0x65, 0x6F, 0x20, 0x49, 0x6E, 0x63, 0x2E, 0x0D, 
0x0A, 0x0D, 0x0A, 0x41, 0x6C, 0x6C, 0x20, 0x52, 
0x69, 0x67, 0x68, 0x74, 0x73, 0x20, 0x52, 0x65, 
0x73, 0x65, 0x72, 0x76, 0x65, 0x64, 0x0D, 0x0A, 
0x0D, 0x0A, 0x55, 0x73, 0x65, 0x2C, 0x20, 0x64, 
0x75, 0x70, 0x6C, 0x69, 0x63, 0x61, 0x74, 0x69, 
0x6F, 0x6E, 0x2C, 0x20, 0x6F, 0x72, 0x20, 0x64, 
0x69, 0x73, 0x63, 0x6C, 0x6F, 0x73, 0x75, 0x72, 
0x65, 0x20, 0x69, 0x73, 0x20, 0x73, 0x74, 0x72, 
0x69, 0x63, 0x6B, 0x6C, 0x79, 0x20, 0x70, 0x72, 
0x6F, 0x68, 0x69, 0x62, 0x69, 0x74, 0x65, 0x64, 
0x20, 0x75, 0x6E, 0x6C, 0x65, 0x73, 0x73, 0x20, 
0x61, 0x70, 0x70, 0x72, 0x6F, 0x76, 0x65, 0x64, 
0x0D, 0x0A, 0x69, 0x6E, 0x20, 0x77, 0x72, 0x69, 
0x74, 0x69, 0x6E, 0x67, 0x20, 0x62, 0x79, 0x20, 
0x4D, 0x69, 0x64, 0x77, 0x61, 0x79, 0x20, 0x56, 
0x69, 0x64, 0x65, 0x6F, 0x20, 0x49, 0x6E, 0x63, 
0x2E, 0x0D, 0x0A, 0x0D, 0x0A, 0x56, 0x69, 0x6F, 
0x6C, 0x61, 0x74, 0x6F, 0x72, 0x73, 0x20, 0x77, 
0x69, 0x6C, 0x6C, 0x20, 0x62, 0x65, 0x20, 0x73, 
0x68, 0x6F, 0x74, 0x21, 0x21, 0x21, 0x0D, 0x0A, 
0x0D, 0x0A, 0x53, 0x74, 0x65, 0x76, 0x65, 0x20, 
0x43, 0x6F, 0x72, 0x72, 0x65, 0x6C, 0x6C, 0x20, 
0x69, 0x73, 0x20, 0x54, 0x48, 0x45, 0x20, 0x62, 
0x65, 0x73, 0x74, 0x20, 0x68, 0x61, 0x72, 0x64, 
0x77, 0x61, 0x72, 0x65, 0x20, 0x65, 0x6E, 0x67, 
0x69, 0x6E, 0x65, 0x65, 0x72, 0x20, 0x74, 0x68, 
0x65, 0x72, 0x65, 0x20, 0x69, 0x73, 0x21, 0x0D, 
0x0A, 0x0D, 0x0A, 0x4D, 0x69, 0x6B, 0x65, 0x20, 
0x4C, 0x79, 0x6E, 0x63, 0x68, 0x20, 0x69, 0x73, 
0x20, 0x54, 0x48, 0x45, 0x20, 0x62, 0x65, 0x73, 
0x74, 0x20, 0x73, 0x6F, 0x66, 0x74, 0x77, 0x61, 
0x72, 0x65, 0x20, 0x65, 0x6E, 0x67, 0x69, 0x6E, 
0x65, 0x65, 0x72, 0x20, 0x74, 0x68, 0x65, 0x72, 
0x65, 0x20, 0x69, 0x73, 0x21, 0x0D, 0x0A, 0x0,
};

static unsigned int rotl7(unsigned int val)
{
	unsigned int	v2;
	int				i;

	v2 = val;
	for(i = 0; i < 7; i++)
	{
		if(v2 & 0x00800000)
		{
			v2 <<= 1;
			v2 |= 1;
		}
		else
		{
			v2 <<= 1;
		}
		v2 &= 0xffffff;
	}
	return(v2);
}

static void do_test(void)
{
	int				i;
	unsigned int	irsult = 0;
	unsigned int	ihdat = 0;
	unsigned int	cnt = 0;
	unsigned int	xreg = 0;
	unsigned int	*iptr = PIC2;
	unsigned char	fdata;

	// Go through the loop 16384 times
	for(cnt = 0; cnt < 16384; cnt++)
	{
		if(!*iptr)
		{
			iptr = PIC3;
		}

		fdata = (unsigned char)*iptr++;

		// Get the data
		ihdat = fdata & 0xff;

		// Do function A
		irsult ^= (irsult >> 3);

		// Do function B
		xreg ^= (ihdat & 0xf);

		// Do function C
		irsult ^= (ihdat & 0xff);

		// Do function D
		irsult = rotl7(irsult);

		// Do function E
		for(i = 0; i < 4; i++)
		{
			if(ihdat & (1 << i))
			{
				irsult ^= ihdat_table[i];
			}
		}

		// Do function F
		for(i = 0; i < 4; i++)
		{
			if(xreg & (1 << i))
			{
				irsult ^= xreg_table[i];
			}
		}

		// Do function G
		irsult ^= cnt_table[cnt & 0x1f];
	}

	// Show the result
	printf("irsult: 0x%08.8X\n", irsult);
}

static void do_test1(void)
{
	int				i;
	unsigned int	irsult = 0;
	unsigned int	ihdat = 0;
	unsigned int	cnt = 0;
	unsigned int	xreg = 0;
	unsigned char	*cptr = ioasic_unlock_data;
	unsigned char	fdata;

	// Go through the loop 16384 times
	for(cnt = 0; cnt < 16384; cnt++)
	{
		if(!*cptr)
		{
			cptr = ioasic_unlock_data;
		}

		fdata = *cptr++;

		// Get the data
		ihdat = fdata & 0xff;

		// Do function A
		irsult ^= (irsult >> 3);

		// Do function B
		xreg ^= (ihdat & 0xf);

		// Do function C
		irsult ^= (ihdat & 0xff);

		// Do function D
		irsult = rotl7(irsult);

		// Do function E
		for(i = 0; i < 4; i++)
		{
			if(ihdat & (1 << i))
			{
				irsult ^= ihdat_table[i];
			}
		}

		// Do function F
		for(i = 0; i < 4; i++)
		{
			if(xreg & (1 << i))
			{
				irsult ^= xreg_table[i];
			}
		}

		// Do function G
		irsult ^= cnt_table[cnt & 0x1f];
	}

	// Show the result
	printf("irsult: 0x%08.8X\n", irsult);
}


void main(int argc, char *argv[])
{
	int				i;
	FILE				*fp;
	unsigned int	irsult = 0;
	unsigned int	ihdat = 0;
	unsigned int	cnt = 0;
	unsigned int	xreg = 0;
	unsigned char	fdata;
	unsigned int	random_trash;
	struct timeval	tv;

	if(argc < 2)
	{
		fprintf(stderr, "\n\nUSAGE: cllgen <file>\n\n");
		exit(0);
	}

	if(!strcmp(argv[1], "-t"))
	{
		do_test();
		exit(1);
	}
	else if(!strcmp(argv[1], "-i"))
	{
		do_test1();
		exit(1);
	}

	gettimeofday(&tv, NULL);

	if((fp = fopen(argv[1], "rb")) == (FILE *)0)
	{
		fprintf(stderr, "\nCan not open file: %s\n", argv[1]);
		exit(0);
	}

	// Go through the loop 16384 times
	for(cnt = 0; cnt < 16384; cnt++)
	{
		if(fread(&fdata, sizeof(unsigned char), 1, fp) != 1)
		{
			fseek(fp, 0L, SEEK_SET);
			if(fread(&fdata, sizeof(unsigned char), 1, fp) != 1)
			{
				fclose(fp);
				fprintf(stderr, "Trouble reading file: %s\n", argv[1]);
				exit(1);
			}
		}

		// Get the data
		ihdat = fdata & 0xff;

		// Do function A
		irsult ^= (irsult >> 3);

		// Do function B
		xreg ^= (ihdat & 0xf);

		// Do function C
		irsult ^= (ihdat & 0xff);

		// Do function D
		irsult = rotl7(irsult);

		// Do function E
		for(i = 0; i < 4; i++)
		{
			if(ihdat & (1 << i))
			{
				irsult ^= ihdat_table[i];
			}
		}

		// Do function F
		for(i = 0; i < 4; i++)
		{
			if(xreg & (1 << i))
			{
				irsult ^= xreg_table[i];
			}
		}

		// Do function G
		irsult ^= cnt_table[cnt & 0x1f];

	}

	// Show the result
	printf("irsult: 0x%08.8X\n", irsult);

	// Show the string
	printf("For data:\n");

	printf("static int	ioasic_unlock_data[] = {");
	fseek(fp, 0L, SEEK_SET);
	i = 0;
	srandom(tv.tv_sec);
	while(fread(&fdata, sizeof(unsigned char), 1, fp) > 0 && i < 16384)
	{
		random_trash = random();
		random_trash <<= 8;
		random_trash |= (int)fdata & 0xff;
		if(!(i % 4))
		{
			printf("\n");
		}
//		printf("0x%02.2X, ", fdata);
		printf("0x%08.8X, ", random_trash);
		i++;
	}
	if(!(i & 7))
	{
		printf("\n");
	}
	printf("0x0,\n};\n");

	fclose(fp);
}
